# 计算机网络

## 1. 基础知识
### 1.1 3种常见的计算机体系结构划分

OSI分层（7层）：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层。
TCP/IP分层（4层）：网络接口层、网际层、运输层、应用层。
五层协议（5层）：物理层、数据链路层、网络层、运输层、应用层。

每一层的作用如下：
- 物理层：激活、维持、关闭通信端点之间的机械特性、电气特性、功能特性以及过程特性。该层为上层协议提供了一个传输数据的物理媒体。物理层的任务就是**透明地传送比特流**。
- 数据链路层：数据链路层在不可靠的物理介质上提供可靠的传输。该层的作用包括：物理地址寻址、数据的成帧、流量控制、数据的检错、重发等。
- 网络层：网络层负责对子网间的数据包进行路由选择。此外，网络层还可以实现拥塞控制、网际互连等功能。
- 传输层：构的最高层，直接**为用户的应用进程提供服务**。
- 运输层的任务是**负责向两个主机中进程之间的通信提供服务**。由于一个主机可同时运行多个进程，因此运输层具有复用和分用的功能。复用是指多个应用层进程可同时使用运输层的服务，分用是指运输层把收到的信息分别交付给应用层中的相应进程。
- 应用层：为操作系统或网络应用程序提供访问网络服务的接口。

### 1.2 常见的网络协议
网络层

- IP协议：网际协议
- ICMP协议：Internet控制报文协议
- ARP协议:地址解析协议
- RARP协议：逆地址解析协议

传输层
- UDP协议：用户数据报协议
- TCP协议：传输控制协议

应用层
- FTP：文件传送协议
- Telenet：远程登录协议
- DNS：域名解析协议
- POP3：邮局协议
- HTTP协议
- SMTP：简单邮件传送协议
- SNMP：简单网络管理协议
- TFTP：简单文件传送协议

## 2. 网际协议IP

### 2.1 IP协议的特点

- **不可靠**：并不保证IP数据报能成功地到达目的地。如果发生某种错误，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法：丢弃该数据报，然后发送ICMP消息报给信源端。任何可靠性必须由上层提供（如TCP）。
- **无连接**：IP并不维护任何关于后续数据报的状态消息，每个连接都是独立的。这也说明，IP数据报可以不按发送顺序接收。

### 2.2 IP地址
IP地址一般有网络号和主机号组成（D类和E类无此分法）。网络号标志主机（或路由器）所连接到的网络，主机号则标志该网络下的主机或路由器。

由于一个路由器至少应当连接到两个网络（这样它才能将IP数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的IP地址。路由器只根据目的站的IP地址的网络号进行路由选择。

![](http://i.imgur.com/Un8baOt.png)

上图中的A类、B类、C类地址都是单播地址（一对一通信），是最常用的。网络号字段的最前面有1-4位的类别位。其中有两个特殊的IP地址，**主机号全为0的IP地址代表网络地址，主机号全为1的IP地址为广播地址。当向某个网络的广播地址发送消息时，该网络内的所有主机都能收到该广播消息。**

A类地址：以0开头，第一个字节范围：0~127；
B类地址：以10开头，第一个字节范围：128~191；
C类地址：以110开头，第一个字节范围：192~223；
D类地址：以1110开头，第一个字节范围为224~239；

3个特殊的IP地址
- **255.255.255.255**
该IP地址指的是受限的广播地址。受限广播地址与一般广播地址（直接广播地址）的区别在于，受限广播地址之只能用于本地网络，路由器不会转发以受限广播地址为目的地址的分组；一般广播地址既可在本地广播，也可跨网段广播。例如：主机192.168.1.1/30上的直接广播数据包后，另外一个网段192.168.1.5/30也能收到该数据报；若发送受限广播数据报，则不能收到。
- **0.0.0.0**
常用于寻找自己的IP地址，例如在我们的RARP，BOOTP和DHCP协议中，若某个未知IP地址的无盘机想要知道自己的IP地址，它就以255.255.255.255为目的地址，向本地范围（具体而言是被各个路由器屏蔽的范围内）的服务器发送IP请求分组。
- **127.0.0.1**
127.0.0.0/8被用作回环地址，回环地址表示本机的地址，常用于对本机的测试，用的最多的是127.0.0.1。

根据用途和安全性级别的不同，IP地址可以大致分为两类：**公共地址（公网地址）和私有地址（内网地址）**。在IP地址中专门保留了三个区域作为私有地址，范围如下：

10.0.0.0/8：10.0.0.0～10.255.255.255；
172.16.0.0/12：172.16.0.0～172.31.255.255；
192.168.0.0/16：192.168.0.0～192.168.255.255。

这三个IP地址段不会被互联网的公用服务器使用，而只能在企业内网里使用。

### 2.3 划分子网
划分子网的方法是从主机号借用若干个位作为子网号subnet-id，而主机号host-id 也就相应减少了若干个位。于是两级IP地址在本单位内部就变为三级IP地址：网络号、子网号和主机号。

IP地址 ::= {<网络号>, <子网号>, <主机号>} 

子网对外部路由器来说隐藏了内部网络组织的细节，在外部看来，不同子网的主机仍属于同一个网络。

凡是从其他网络发送给本单位某个主机的IP数据报，仍然是根据IP数据报的目的网络号net-id，先找到连接在本单位网络上的路由器。然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。最后就将 IP 数据报直接交付目的主机。

如何正确地区分子网号和主机号是一个问题，这可以通过**子网掩码**来确定。将**子网号全设为1**的IP地址为子网掩码。给定IP地址和子网掩码以后，主机就可以确定IP数据报的目的地是本子网的主机，本网络中其他子网的主机，还是其他网络的主机。

### 2.4 ARP协议与RARP协议
RAP为IP地址到对应硬件地址之间提供动态映射；RARP则相反。

ARP协议的工作原理
- 首先，每个主机都会在自己的 ARP 缓冲区中建立一个 ARP 列表，以表示 IP 地址和 MAC 地址之间的对应关系。
- 当源主机要发送数据时，首先检查 ARP 列表中是否有对应 IP 地址的目的主机的 MAC 地址，如果有，则直接发送数据，如果没有，就向本网段的所有主机发送 ARP 数据包，该数据包包括的内容有：源主机 IP 地址，源主机 MAC 地址，目的主机的 IP 地址。
- 当本网络的所有主机收到该 ARP 数据包时，首先检查数据包中的 IP 地址是否是自己的 IP 地址，如果不是，则忽略该数据包，如果是，则首先从数据包中取出源主机的 IP 和 MAC 地址写入到 ARP 列表中，如果已经存在，则覆盖，然后将自己的 MAC 地址写入 ARP 响应包中，告诉源主机自己是它想要找的 MAC 地址。
- 源主机收到 ARP 响应包后。将目的主机的 IP 和 MAC 地址写入 ARP 列表，并利用此信息发送数据。如果源主机一直没有收到 ARP 响应数据包，表示 ARP 查询失败。

### 2.5 ICMP（Internet控制报文协议）
ICMP是IP曾的一个组成部分，它传递差错报文以及其他需要注意的信息。ICMP报文是在IP数据报内部（IP首部+ICMP报文）被传输的。ICMP报文由类型字段、代码字段、检验和和其他字节组成，前两个字段决定了ICMP报文的类型。

**ICMP地址掩码请求**，用于无盘系统在引导过程中获取自己自己的子网掩码。该ICMP报文的类型字段为17或18，代码字段为0，并返回32位子网掩码。

**ICMP端口不可达差错**，如果收到一份UDP数据报而目的端口与某个正在使用的进程不相符，那么UDP返回一个ICMP不可达报文。ICMP报文必须包括生成差错报文的数据报IP首部，还必须至少包括跟在该IP首部后面的前8个字节。

## 3. TCP协议

### 3.1 TCP服务的特点
TCP提供一种**面向连接的、可靠的字节流服务**。面向连接意味着应用程序在使用TCP协议之前，必须先建立TCP连接。在传送数据完毕后，必须释放已经建立的TCP连接。TCP通过以下方式来提供可靠性：

- 应用数据被分割成TCP认为最适合发送的数据块。
- 超时重传。当TCP发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到确认，将重发这个报文段。
- 当TCP收到发自TCP连接另一端的数据后，他将发送一个确认。该确认通常将推迟几分之一秒。
- TCP将保持他首部和数据的检验和。
- 由于IP数据报的到达可能会失序，因此TCP报文段的到达也可能失序。如有必要，TCP将对收到的数据进行重新排序，并以正确的顺序交付给应用层。
- 既然IP数据报会发生重复，TCP的接收端必须丢弃重复的数据。
- 流量控制。防止较快主机致使较慢主机的缓冲区溢出。

###3.2 TCP的首部
![](http://upload-images.jianshu.io/upload_images/53611-da2d1badf7d86d0f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

TCP虽然是面向字节流的，但TCP传送的数据单元却是报文段。一个TCP报文段分为首部和数据两部分，而TCP的全部功能都体现在它首部中各字段的作用。因此，只有弄清TCP首部各字段的作用才能掌握TCP的工作原理。TCP报文首部固定部分各字段的意义如下：
1. **源端口和目的端口**
各占两字节，分别写入源端口号和目的端口号。TCP的分用也是通过端口实现的。

2. **报文段序号**
占4字节。在一个TCP连接中传送的字节流中的每一个字节都按顺序编号。整个要传送的字节流的起始序号必须在连接建立时设置，首部中的序号字段值则是指本报文所发送的数据的第一个字节的序号。

3. **确认号**
期望收到对方下一个报文段的第一个数据字节的序号。若确认号为N，则表明到序号N-1为止的所有数据都已正确收到。

4. **数据偏移**
指出TCP报文段的数据起始处距离TCP报文段的起始处有多远，实际上指出了TCP报文段的首部长度。

5. **6个控制位**
确认ACK：TCP规定，在连接建立后所有传送的报文段都必须把ACK置1。
复位RST：当RST=1时，表明TCP连接中出现严重错误，必须释放连接，然后再重新建立运输连接。
同步SYN：在连接建立时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使用SYN=1和ACK=1.
终止FIN：用来释放一个连接。当FIN=1时，表明此报文段的发送方的数据已发送完毕，并要求释放运输连接。

6. **窗口**
窗口字段明确指出了现在允许对方发送的数据量，该值经常在动态变化着。例如，设确认号是701，窗口字段是1000。这就表明从701算起，发送此报文段的一方还有接收1000个字节数据的接收缓存空间。

### 3.3 TCP连接的建立与终止过程

![](http://images0.cnblogs.com/blog2015/621032/201508/092017231747399.jpg)

三次握手：
第一次握手：客户端发送syn包(syn=x)到服务器，并进入SYN_SEND状态，等待服务器确认；
第二次握手：服务器收到syn包，必须确认客户的SYN（ack=x+1），同时自己也发送一个SYN包（syn=y），即SYN+ACK包，此时服务器进入SYN_RECV状态；
第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=y+1)，此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。
握手过程中传送的包里不包含数据，三次握手完毕后，客户端与服务器才正式开始传送数据。理想状态下，TCP连接一旦建立，在通信双方中的任何一方主动关闭连接之前，TCP 连接都将被一直保持下去。

四次握手
与建立连接的“三次握手”类似，断开一个TCP连接则需要“四次握手”。
第一次挥手：主动关闭方发送一个FIN，用来关闭主动方到被动关闭方的数据传送，也就是主动关闭方告诉被动关闭方：我已经不 会再给你发数据了(当然，在fin包之前发送出去的数据，如果没有收到对应的ack确认报文，主动关闭方依然会重发这些数据)，但是，此时主动关闭方还可 以接受数据。
第二次挥手：被动关闭方收到FIN包后，发送一个ACK给对方，确认序号为收到序号+1（与SYN相同，一个FIN占用一个序号）。
第三次挥手：被动关闭方发送一个FIN，用来关闭被动关闭方到主动关闭方的数据传送，也就是告诉主动关闭方，我的数据也发送完了，不会再给你发数据了。
第四次挥手：主动关闭方收到FIN后，发送一个ACK给被动关闭方，确认序号为收到序号+1，至此，完成四次挥手。

## 4. 超文本传送协议HTTP

HTTP协议包括哪些请求？

GET：请求读取由URL所标志的信息。
POST：给服务器添加信息（如注释）。
PUT：在给定的URL下存储一个文档。
DELETE：删除给定的URL所标志的资源。

其中POST与GET的区别如下：
- Get是从服务器上获取数据，Post是向服务器传送数据。
- Get是把参数数据队列加到提交表单的Action属性所指向的URL中，值和表单内各个字段一一对应，在URL中科院看到。
- Get传送的数据量小，不能大于2KB；post传送的数据量较大，一般被默认为不受限制。
- 根据HTTP规范，GET用于信息获取，而且应该是安全的和幂等的。
 - 所谓安全的意味着该操作用于获取信息而非修改信息。换句话说，GET 请求一般不应产生副作用。就是说，它仅仅是获取资源信息，就像数据库查询一样，不会修改，增加数据，不会影响资源的状态。
 - 幂等的意味着对同一URL的多个请求应该返回同样的结果。

## 5. TCP对应的协议和UDP对应的协议

**TCP对应的协议**：

1. FTP：定义了文件传输协议，使用21端口。常说某某计算机开了FTP服务便是启动了文件传输服务。下载文件，上传主页，都要用到FTP服务。
2. Telnet：它是一种用于远程登陆的端口，用户可以以自己的身份远程连接到计算机上，通过这种端口可以提供一种基于DOS模式下的通信服务。如以前的BBS是-纯字符界面的，支持BBS的服务器将23端口打开，对外提供服务。
3. SMTP：定义了简单邮件传送协议，现在很多邮件服务器都用的是这个协议，用于发送邮件。如常见的免费邮件服务中用的就是这个邮件服务端口，所以在电子邮件设置-中常看到有这么SMTP端口设置这个栏，服务器开放的是25号端口。
4. POP3：它是和SMTP对应，POP3用于接收邮件。通常情况下，POP3协议所用的是110端口。也是说，只要你有相应的使用POP3协议的程序（例如Fo-xmail或Outlook），就可以不以Web方式登陆进邮箱界面，直接用邮件程序就可以收到邮件（如是163邮箱就没有必要先进入网易网站，再进入自己的邮-箱来收信）。
5. HTTP协议：是从Web服务器传输超文本到本地浏览器的传送协议。

**UDP对应的协议**：
1. DNS：用于域名解析服务，将域名地址转换为IP地址。DNS用的是53号端口。
**DNS工作原理**：当DNS客户机需要在程序中使用名称时，它会查询DNS服务器来解析该名称。客户机发送的每条查询信息包括三条信息：包括：指定的DNS域名，指定的查询类型，DNS域名的指定类别。该应用一般不直接为用户使用，而是为其他应用服务，如HTTP，SMTP等在其中需要完成主机名到IP地址的转换。
2. SNMP：简单网络管理协议，使用161号端口，是用来管理网络设备的。由于网络设备很多，无连接的服务就体现出其优势。
3. TFTP(Trival File Transfer Protocal)，简单文件传输协议，该协议在熟知端口69上使用UDP服务。

## 6. 面试题精选

### 例题1：TCP和UDP有什么区别？
TCP是传输控制协议，提供的是面向连接、可靠的字节流服务。当客户和服务器批次交换数据前，必须建立TCP连接之后才能传输数据。TCP提供超时重传、丢弃重复数据、流量控制等功能，保证数据能从一端传到另一端。

UDP是用户数据报协议，是一个简单的面向数据报的运输层协议。UDP不提供可靠性，不保证数据能够到达目的地。由于UDP在传输数据前不用在客户和服务器之间建立连接，且没有超时重传等机制，故而传输速度很快。

### 例题2：TCP的可靠性如何保证？
TCP的可靠性是通过顺序编号和确认（ACK）来实现的。

### 例题3：在浏览器中输入www.baidu.com后执行的全部过程

1. 客户端浏览器通过DNS解析到www.baidu.com的IP地址220.181.27.48，通过这个IP地址找到客户端到服务器的路径。客户端浏览器发起一个HTTP会话到220.161.27.48，然后通过TCP进行封装数据包，输入到网络层。
2. 在客户端的传输层，把HTTP会话请求分成报文段，添加源和目的端口，如服务器使用80端口监听客户端的请求，客户端由系统随机选择一个端口如5000，与服务器进行交换，服务器把相应的请求返回给客户端的5000端口。然后使用IP层的IP地址查找目的端。
3. 客户端的网络层不用关系应用层或者传输层的东西，主要做的是通过查找路由表确定如何到达服务器，期间可能经过多个路由器，这些都是由路由器来完成的工作，我不作过多的描述，无非就是通过查找路由表决定通过那个路径到达服务器。
4. 客户端的链路层，包通过链路层发送到路由器，通过邻居协议查找给定IP地址的MAC地址，然后发送ARP请求查找目的地址，如果得到回应后就可以使用ARP的请求应答交换的IP数据包现在就可以传输了，然后发送IP数据包到达服务器的地址。

### 例题4：牛客网由于访问客户量的增长,原来的服务器不足以维持请求,经常发生宕机的突发情况,因此为了解决这个问题,CEO决定新增加几台服务器,那么问题是这些接入WEB服务器第一次被访问到时，不同协议的发生顺序是下面中的（ARP -> DNS -> HTTP）。
解析：当你给WEB服务器接上网线的时候，它会自动发送一条ARP信息，使得接入网关能找的到它；网关上会形成一条MAC地址到IP地址的映射记录。如用户在浏览器中输入域名，如本地DNS缓存中没有，必然会进行一次DNS查询，以确定该域名的IP地址。获得DNS对应的IP地址以后，使用HTTP协议访问web服务器（不考虑TCP三次握手建立连接的阶段）。 

### 例题5：将一个C类网络划分为3个子网，每个子网最少要容纳55台主机，使用的子网掩码是？（2017乐视实习生）
答：255.255.255.192

### 例题5：IP路由表包括哪几项内容？
IP路由表通常包括三项内容，他们是**子网掩码、目的网络地址、到目的网络路径上“下一个”路由器的地址**。